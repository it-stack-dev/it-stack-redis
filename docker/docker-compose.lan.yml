# Lab 04-02: External Dependencies — Redis Sentinel HA
# Purpose: 1 master + 2 replicas + 3 sentinels for automatic failover
#          Proves Redis HA before Phase 2 services (Nextcloud, Mattermost) depend on it.
#
# Usage:
#   docker compose -f docker/docker-compose.lan.yml up -d
#   Master:       localhost:6379   (read-write, auto-elected)
#   Replica 1:    localhost:6380   (read-only)
#   Replica 2:    localhost:6381   (read-only)
#   Sentinel 1:   localhost:26379  (quorum member)
#   Sentinel 2:   localhost:26380  (quorum member)
#   Sentinel 3:   localhost:26381  (quorum member)
#
# Failover: sentinel quorum=2. Kill the master container; sentinel elects a
# new master within ~10 seconds. Clients reconnecting via sentinel always
# find the current master.

services:

  # ─── MASTER ──────────────────────────────────────────────────────────────
  redis-master:
    image: redis:7-alpine
    container_name: it-stack-redis-master
    restart: unless-stopped
    command: >
      redis-server
        --requirepass Lab02Password!
        --appendonly yes
        --appendfsync everysec
        --maxmemory 256mb
        --maxmemory-policy allkeys-lru
        --loglevel notice
        --bind 0.0.0.0
    ports:
      - "6379:6379"
    volumes:
      - redis-master-data:/data
    networks:
      redis-net:
        aliases: [redis-master]
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "Lab02Password!", "--no-auth-warning", "PING"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ─── REPLICA 1 ───────────────────────────────────────────────────────────
  redis-replica-1:
    image: redis:7-alpine
    container_name: it-stack-redis-replica-1
    restart: unless-stopped
    command: >
      redis-server
        --requirepass Lab02Password!
        --replicaof redis-master 6379
        --masterauth Lab02Password!
        --appendonly yes
        --loglevel notice
        --bind 0.0.0.0
    ports:
      - "6380:6379"
    volumes:
      - redis-replica-1-data:/data
    networks:
      - redis-net
    depends_on:
      redis-master:
        condition: service_healthy

  # ─── REPLICA 2 ───────────────────────────────────────────────────────────
  redis-replica-2:
    image: redis:7-alpine
    container_name: it-stack-redis-replica-2
    restart: unless-stopped
    command: >
      redis-server
        --requirepass Lab02Password!
        --replicaof redis-master 6379
        --masterauth Lab02Password!
        --appendonly yes
        --loglevel notice
        --bind 0.0.0.0
    ports:
      - "6381:6379"
    volumes:
      - redis-replica-2-data:/data
    networks:
      - redis-net
    depends_on:
      redis-master:
        condition: service_healthy

  # ─── SENTINEL 1 ──────────────────────────────────────────────────────────
  redis-sentinel-1:
    image: redis:7-alpine
    container_name: it-stack-redis-sentinel-1
    restart: unless-stopped
    command: >
      sh -c "
        redis-sentinel /etc/redis/sentinel.conf
        --sentinel announce-ip redis-sentinel-1
        --sentinel announce-port 26379
      "
    entrypoint:
      - sh
      - -c
      - |
        cat > /tmp/sentinel.conf <<EOF
        bind 0.0.0.0
        sentinel resolve-hostnames yes
        sentinel announce-hostnames no
        sentinel monitor it-stack-master redis-master 6379 2
        sentinel auth-pass it-stack-master Lab02Password!
        sentinel down-after-milliseconds it-stack-master 5000
        sentinel failover-timeout it-stack-master 10000
        sentinel parallel-syncs it-stack-master 1
        EOF
        exec redis-sentinel /tmp/sentinel.conf
    ports:
      - "26379:26379"
    networks:
      - redis-net
    depends_on:
      redis-master:
        condition: service_healthy

  # ─── SENTINEL 2 ──────────────────────────────────────────────────────────
  redis-sentinel-2:
    image: redis:7-alpine
    container_name: it-stack-redis-sentinel-2
    restart: unless-stopped
    entrypoint:
      - sh
      - -c
      - |
        cat > /tmp/sentinel.conf <<EOF
        bind 0.0.0.0
        sentinel resolve-hostnames yes
        sentinel announce-hostnames no
        sentinel monitor it-stack-master redis-master 6379 2
        sentinel auth-pass it-stack-master Lab02Password!
        sentinel down-after-milliseconds it-stack-master 5000
        sentinel failover-timeout it-stack-master 10000
        sentinel parallel-syncs it-stack-master 1
        EOF
        exec redis-sentinel /tmp/sentinel.conf
    ports:
      - "26380:26379"
    networks:
      - redis-net
    depends_on:
      redis-master:
        condition: service_healthy

  # ─── SENTINEL 3 ──────────────────────────────────────────────────────────
  redis-sentinel-3:
    image: redis:7-alpine
    container_name: it-stack-redis-sentinel-3
    restart: unless-stopped
    entrypoint:
      - sh
      - -c
      - |
        cat > /tmp/sentinel.conf <<EOF
        bind 0.0.0.0
        sentinel resolve-hostnames yes
        sentinel announce-hostnames no
        sentinel monitor it-stack-master redis-master 6379 2
        sentinel auth-pass it-stack-master Lab02Password!
        sentinel down-after-milliseconds it-stack-master 5000
        sentinel failover-timeout it-stack-master 10000
        sentinel parallel-syncs it-stack-master 1
        EOF
        exec redis-sentinel /tmp/sentinel.conf
    ports:
      - "26381:26379"
    networks:
      - redis-net
    depends_on:
      redis-master:
        condition: service_healthy

volumes:
  redis-master-data:
    name: it-stack-redis-master-data
  redis-replica-1-data:
    name: it-stack-redis-replica-1-data
  redis-replica-2-data:
    name: it-stack-redis-replica-2-data

networks:
  redis-net:
    name: it-stack-redis-net
    driver: bridge
