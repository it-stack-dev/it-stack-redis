# Lab 06 -- Production: Redis HA with Sentinel, streaming replicas, Redis Exporter
---
x-redis-common: &redis-common
  image: redis:7-alpine
  restart: always
  networks:
    - redis-prod-net

services:
  redis-master:
    <<: *redis-common
    container_name: it-stack-redis-master
    ports:
      - "6379:6379"
    command: >
      redis-server
      --requirepass Lab06Password!
      --masterauth Lab06Password!
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --loglevel notice
    volumes:
      - redis-master-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "Lab06Password!", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 768M

  redis-replica-1:
    <<: *redis-common
    container_name: it-stack-redis-replica-1
    ports:
      - "6380:6379"
    command: >
      redis-server
      --requirepass Lab06Password!
      --masterauth Lab06Password!
      --replicaof redis-master 6379
      --appendonly yes
      --replica-read-only yes
    volumes:
      - redis-replica-1-data:/data
    depends_on:
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "Lab06Password!", "ping"]
      interval: 5s
      timeout: 3s
      retries: 15
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 768M

  redis-replica-2:
    <<: *redis-common
    container_name: it-stack-redis-replica-2
    ports:
      - "6381:6379"
    command: >
      redis-server
      --requirepass Lab06Password!
      --masterauth Lab06Password!
      --replicaof redis-master 6379
      --appendonly yes
      --replica-read-only yes
    volumes:
      - redis-replica-2-data:/data
    depends_on:
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "Lab06Password!", "ping"]
      interval: 5s
      timeout: 3s
      retries: 15
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 768M

  redis-sentinel-1:
    <<: *redis-common
    container_name: it-stack-redis-sentinel-1
    ports:
      - "26379:26379"
    command: sh -c "redis-sentinel /etc/redis/sentinel.conf"
    volumes:
      - ./production/sentinel.conf:/etc/redis/sentinel.conf:ro
    depends_on:
      redis-master:
        condition: service_healthy
      redis-replica-1:
        condition: service_healthy
      redis-replica-2:
        condition: service_healthy

  redis-sentinel-2:
    <<: *redis-common
    container_name: it-stack-redis-sentinel-2
    ports:
      - "26380:26379"
    command: sh -c "redis-sentinel /etc/redis/sentinel.conf"
    volumes:
      - ./production/sentinel.conf:/etc/redis/sentinel.conf:ro
    depends_on:
      redis-master:
        condition: service_healthy

  redis-sentinel-3:
    <<: *redis-common
    container_name: it-stack-redis-sentinel-3
    ports:
      - "26381:26379"
    command: sh -c "redis-sentinel /etc/redis/sentinel.conf"
    volumes:
      - ./production/sentinel.conf:/etc/redis/sentinel.conf:ro
    depends_on:
      redis-master:
        condition: service_healthy

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: it-stack-redis-exporter
    ports:
      - "9121:9121"
    environment:
      REDIS_ADDR: "redis://redis-master:6379"
      REDIS_PASSWORD: "Lab06Password!"
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - redis-prod-net
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M

networks:
  redis-prod-net:
    driver: bridge

volumes:
  redis-master-data:
  redis-replica-1-data:
  redis-replica-2-data:
