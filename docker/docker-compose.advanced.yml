# Lab 04-03: Advanced Features — Redis Cluster (3 primary + 3 replica shards)
# Purpose: Horizontal sharding, automatic failover, cluster-aware clients
#
# Usage:
#   docker compose -f docker/docker-compose.advanced.yml up -d
#   Wait ~15s for cluster-init to complete, then:
#   redis-cli -c -p 7001 -a Lab03Password! CLUSTER INFO
#   Nodes: localhost:7001-7006 (connect with -c for cluster mode)

services:

  # ─── 6 CLUSTER NODES ─────────────────────────────────────────────────────
  redis-node-1:
    image: redis:7-alpine
    container_name: it-stack-redis-c1
    restart: unless-stopped
    command: >
      redis-server
        --port 7001
        --requirepass "Lab03Password!"
        --masterauth "Lab03Password!"
        --cluster-enabled yes
        --cluster-config-file /data/nodes-7001.conf
        --cluster-node-timeout 5000
        --appendonly yes
        --appendfilename "appendonly-7001.aof"
    ports:
      - "7001:7001"
    volumes: [redis-node-1:/data]
    networks: [redis-cluster-net]

  redis-node-2:
    image: redis:7-alpine
    container_name: it-stack-redis-c2
    restart: unless-stopped
    command: >
      redis-server
        --port 7002
        --requirepass "Lab03Password!"
        --masterauth "Lab03Password!"
        --cluster-enabled yes
        --cluster-config-file /data/nodes-7002.conf
        --cluster-node-timeout 5000
        --appendonly yes
        --appendfilename "appendonly-7002.aof"
    ports:
      - "7002:7002"
    volumes: [redis-node-2:/data]
    networks: [redis-cluster-net]

  redis-node-3:
    image: redis:7-alpine
    container_name: it-stack-redis-c3
    restart: unless-stopped
    command: >
      redis-server
        --port 7003
        --requirepass "Lab03Password!"
        --masterauth "Lab03Password!"
        --cluster-enabled yes
        --cluster-config-file /data/nodes-7003.conf
        --cluster-node-timeout 5000
        --appendonly yes
        --appendfilename "appendonly-7003.aof"
    ports:
      - "7003:7003"
    volumes: [redis-node-3:/data]
    networks: [redis-cluster-net]

  redis-node-4:
    image: redis:7-alpine
    container_name: it-stack-redis-c4
    restart: unless-stopped
    command: >
      redis-server
        --port 7004
        --requirepass "Lab03Password!"
        --masterauth "Lab03Password!"
        --cluster-enabled yes
        --cluster-config-file /data/nodes-7004.conf
        --cluster-node-timeout 5000
        --appendonly yes
        --appendfilename "appendonly-7004.aof"
    ports:
      - "7004:7004"
    volumes: [redis-node-4:/data]
    networks: [redis-cluster-net]

  redis-node-5:
    image: redis:7-alpine
    container_name: it-stack-redis-c5
    restart: unless-stopped
    command: >
      redis-server
        --port 7005
        --requirepass "Lab03Password!"
        --masterauth "Lab03Password!"
        --cluster-enabled yes
        --cluster-config-file /data/nodes-7005.conf
        --cluster-node-timeout 5000
        --appendonly yes
        --appendfilename "appendonly-7005.aof"
    ports:
      - "7005:7005"
    volumes: [redis-node-5:/data]
    networks: [redis-cluster-net]

  redis-node-6:
    image: redis:7-alpine
    container_name: it-stack-redis-c6
    restart: unless-stopped
    command: >
      redis-server
        --port 7006
        --requirepass "Lab03Password!"
        --masterauth "Lab03Password!"
        --cluster-enabled yes
        --cluster-config-file /data/nodes-7006.conf
        --cluster-node-timeout 5000
        --appendonly yes
        --appendfilename "appendonly-7006.aof"
    ports:
      - "7006:7006"
    volumes: [redis-node-6:/data]
    networks: [redis-cluster-net]

  # ─── CLUSTER INIT — creates the 6-node cluster (runs once then exits) ─────
  redis-cluster-init:
    image: redis:7-alpine
    container_name: it-stack-redis-cluster-init
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
      - redis-node-4
      - redis-node-5
      - redis-node-6
    networks: [redis-cluster-net]
    entrypoint: >
      sh -c "
        sleep 5 &&
        redis-cli
          -a Lab03Password!
          --cluster create
          it-stack-redis-c1:7001
          it-stack-redis-c2:7002
          it-stack-redis-c3:7003
          it-stack-redis-c4:7004
          it-stack-redis-c5:7005
          it-stack-redis-c6:7006
          --cluster-replicas 1
          --cluster-yes
      "

volumes:
  redis-node-1:
  redis-node-2:
  redis-node-3:
  redis-node-4:
  redis-node-5:
  redis-node-6:

networks:
  redis-cluster-net:
    driver: bridge
